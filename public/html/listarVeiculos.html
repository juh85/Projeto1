<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <title>Lista de Veiculos</title>
    <!-- Importando o CSS do Bootstrap via CDN -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />

    <link rel="stylesheet" href="../css/styleAdm.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,200..1000;1,200..1000&display=swap"
      rel="stylesheet"
    />
    <!-- Importando o JavaScript do Bootstrap via CDN -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </head>

  <body>
    <header id="cabecalho">
      <h1><a href="./areaAdm.html">Área Administrativa</a></h1>
      <nav id="menu">
        <ul>
          <li><a href="./index.html">Cadastrar Veiculo</a></li>
          <li><a href="./novoUsuario.html">Novo Usuario</a></li>
          <li><a href="./contato.html">Contato</a></li>
        </ul>
      </nav>
    </header>

    <div class="container_adm">
      <div class="adm">
        <h2>Lista de Veiculos</h2>
      </div>

      <table class="lista">
        <thead>
          <tr>
            <th>Indentificador</th>
            <th>Proprietário</th>
            <th>Modelo do carro</th>
            <th>Placa</th>
            <th>Número da vaga</th>
            <th>Torre</th>
            <th>Apartamento</th>
            <th>Opções</th>
          </tr>
        </thead>

        <tbody id="tabelaCorpo">
          <script>
            // Função assíncrona para carregar os dados da API
            async function carregarDados() {
              try {
                // Fazer a requisição para a API
                const response = await fetch(
                  "http://localhost:3000/listarVeiculos"
                );

                if (!response.ok) {
                  throw new Error("Erro ao buscar dados");
                }
                // Converter a resposta para JSON
                const dados = await response.json();

                // Obter o corpo da tabela html
                const tabelaCorpo = document.getElementById("tabelaCorpo");

                // Limpar a tabela IMPORTANTE PARA EVITAR DUPLICAÇÃO
                tabelaCorpo.innerHTML = "";

                // criar as linhas da tabela
                dados.forEach((item) => {
                  const linha = document.createElement("tr");

                  // Criar celulas para cada coluna (FORMA ANTIGA E REPETITIVA, POIS TERIA QUE CRIAR UMA CELULA PARA CADA COLUNA)
                  // const celulaId_veiculo = document.createElement("td");
                  // celulaId_veiculo.textContent = item.id_veiculo;
                  // linha.appendChild(celulaId_veiculo);

                  // Criar celulas para cada coluna (FORMA MAIS SIMPLIFICADA PARA EVITAR REPETIÇÃO)
                  linha.innerHTML = `
                      <td>${item.id_veiculo}</td>
                      <td>${item.proprietario}</td>
                      <td>${item.modelo}</td>
                      <td>${item.placa}</td>
                      <td>${item.numVagas}</td>
                      <td>${item.torre}</td>
                      <td>${item.apartamento}</td>
                      <td></td>
                 `;

                  const celulaOpcoes = linha.lastElementChild;

                  // criar o elemento do botão Editar
                  const botaoEditar = document.createElement("button");
                  botaoEditar.textContent = "Editar";
                  botaoEditar.className = "btn btn-primary";

                  // criar evento do botão de editar
                  botaoEditar.onclick = () => {
                    // redireciona para a pagina de edição
                    window.location.href = `editarVeiculos.html?id=${item.id_veiculo}`;
                  };

                  // criar o elemento do botão Excluir
                  const botaoExcluir = document.createElement("button");
                  botaoExcluir.textContent = "Excluir";
                  botaoExcluir.className = "btn btn-danger";

                  botaoExcluir.onclick = async () => {
                    if (!confirm("Deseja realmente excluir o cadastro?"))
                      return;

                    try {
                      // chamar a API para excluir o cadastro
                      const responseExcluir = await fetch(
                        `http://localhost:3000/excluirVeiculos/${item.id_veiculo}`,
                        {
                          method: "DELETE",
                        }
                      );
                      const data = await responseExcluir.json();
                      if (!responseExcluir.ok) {
                        throw new Error(
                          data.message ||
                            `Erro ao excluir o cadastro (${responseExcluir.status})`
                        );
                      }

                      //remove a linha da tabela
                      linha.remove();

                      alert(data.message || "Cadastro excluido com sucesso!");
                    } catch (error) {
                      console.error("Erro ao excluir o cadastro:", error);
                      alert(
                        error.message ||
                          "Erro ao excluir o cadastro. Tente novamente."
                      );
                    }
                  };

                  //criar um container flex para colocar os botões lado a lado
                  const container = document.createElement("div");
                  container.style.display = "flex";
                  container.style.gap = "8px";

                  // adicionar o botão no container
                  container.append(botaoEditar, botaoExcluir);

                  // adicionar na celula de opções
                  celulaOpcoes.appendChild(container);

                  tabelaCorpo.appendChild(linha);
                });
              } catch (error) {
                console.error("Não foi possível carregar os dados:", error);
              }
            }
            // Chamar a função para carregar os dados quando a página for carregada
            document.addEventListener("DOMContentLoaded", carregarDados);
          </script>
        </tbody>
      </table>
    </div>

    <div id="footer"></div>
    <script src="../js/scripts.js"></script>
  </body>
</html>
