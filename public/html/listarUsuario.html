<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <title>Lista de Usuários</title>
    <!-- Importando o CSS do Bootstrap via CDN -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />

    <link rel="stylesheet" href="../css/styleAdm.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,200..1000;1,200..1000&display=swap"
      rel="stylesheet"
    />
    <!-- Importando o JavaScript do Bootstrap via CDN -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </head>

  <body>
    <header id="cabecalho">
      <h1><a href="./areaAdm.html">Área Administrativa</a></h1>
      <nav id="menu">
        <ul>
          <li><a href="./index.html">Cadastrar Veiculo</a></li>
          <li><a href="./novoUsuario.html">Novo Usuario</a></li>
          <li><a href="./contato.html">Contato</a></li>
        </ul>
      </nav>
    </header>

    <div class="container_adm">
      <div class="adm">
        <h2>Lista de Usuários</h2>
      </div>

      <table class="lista">
        <thead>
          <tr>
            <th>Indentificador</th>
            <th>Email</th>
            <th>Nome</th>
            <th>CPF</th>
            <th>Cargo</th>
            <th>Opções</th>
          </tr>
        </thead>

        <tbody id="tabelaCorpo">
          <script>
            // Função assíncrona para carregar os dados da API
            async function carregarDadosUsu() {
              try {
                // fazer a requisição para a API
                const responseUsuario = await fetch(
                  "http://localhost:3000/listaUsuario"
                );

                if (!responseUsuario.ok) {
                  throw new Error("Erro ao buscar dados");
                }
                // Converter a resposta para JSON
                const dadosUsu = await responseUsuario.json();

                // Obter o corpo da tabela html
                const tabelaCorpo = document.getElementById("tabelaCorpo");

                // limpa a tabela IMPORTANTE PARA EVITAR DUPLICAÇÃO
                tabelaCorpo.innerHTML = "";

                // Iterar sobre os dados e criar as linhas da tabela
                dadosUsu.forEach((item) => {
                  const linha = document.createElement("tr");

                  // criar as linhas da tabela
                  linha.innerHTML = `
                    <td>${item.id_usuario}</td>
                    <td>${item.email}</td>
                    <td>${item.nome}</td>
                    <td>${item.cpf}</td>
                    <td>${item.cargo}</td>
                    <td></td>
                  `;

                  const celulaOpcoes = linha.lastElementChild;

                  // criar o elemento do botão Editar
                  const botaoEditar = document.createElement("button");
                  botaoEditar.textContent = "Editar";
                  botaoEditar.className = "btn btn-primary";

                  // criar evento do botão de editar
                  botaoEditar.onclick = () => {
                    // redireciona para a pagina de edição
                    window.location.href = `editarUsuario.html?id=${item.id_usuario}`;
                  };

                  // criar o elemento do botão Excluir
                  const botaoExcluir = document.createElement("button");
                  botaoExcluir.textContent = "Excluir";
                  botaoExcluir.className = "btn btn-danger";

                  // criar o evento do botão excluir
                  botaoExcluir.onclick = async () => {
                    if (!confirm("Deseja realmente excluir o usuário?")) return;

                    try {
                      // chamar a API para excluir o usuário
                      const responseExcluir = await fetch(
                        `http://localhost:3000/excluirUsuario/${item.id_usuario}`,
                        {
                          method: "DELETE",
                        }
                      );
                      const data = await responseExcluir.json();
                      if (!responseExcluir.ok) {
                        throw new Error(
                          data.message ||
                            `Erro ao excluir o usuário (${responseExcluir.status})`
                        );
                      }

                      //remove a linha da tabela
                      linha.remove();
                      alert(data.message || "Usuário excluído com sucesso!");
                    } catch (error) {
                      console.error("Erro ao excluir o usuário:", error);
                      alert(
                        error.message ||
                          "Erro ao excluir o usuário. Tente novamente."
                      );
                    }
                  };

                  // criar um container flex para colocar os botões lado a lado
                  const container = document.createElement("div");
                  container.style.display = "flex";
                  container.style.gap = "8px";

                  // adicionar o botão no container
                  container.append(botaoEditar, botaoExcluir);

                  // adicionar na celula de opções
                  celulaOpcoes.appendChild(container);

                  tabelaCorpo.appendChild(linha);
                });
              } catch (error) {
                console.error("Não foi possivel carregar os dados:", error);
              }
            }
            // Chamar a função para carregar os dados quando a página for carregada
            document.addEventListener("DOMContentLoaded", carregarDadosUsu);
          </script>
        </tbody>
      </table>
    </div>

    <div id="footer"></div>
    <script src="../js/scripts.js"></script>
  </body>
</html>
